<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Test LiveChat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" " crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script src="https://pages-github.b-cdn.net/webcomponents/input.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gun/0.2020.1240/gun.min.js" integrity="sha512-DXhMSo4XT1xlS/IsgKbFlUz34Twe8z56oIt+NwVmwmVeN27nXfdZCN35ruF5ZLa8NfTfjugpdLIoFi2DtSyIWA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gun/0.2020.1240/axe.js" integrity="sha512-2IOSn3n0le20q8/BKHvoAPwtcYiAsDh8XumTZvdbjQnh1uD/QBaBdQY20Cx6EckT/+dcT+wveJvyZtljhkjW3g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  </head>
  <body>
    <div class="container-fluid" id="biodata-wrapper">
      <div class="row">
        <div class="col">
          <h1>LiveChat</h1>
          <div>
            <p>Silakan mengisi biodata</p>
            <c-input id='nama' type="text" label="Nama"></c-input>
            <c-input id="nowa" type='text' label='Nomor Whatsapp'></c-input>
            <button id="save-biodata" class="btn btn-primary">Simpan</button>
          </div>
        </div>
      </div>
    </div>
    <div class="container-fluid d-none" id='chat-wrapper'>
      <div class="row">
        <div class="col">
          <div class='text-center'>
            <p class="m-0 text-primary" style="font-weight: bold;" id="visitor-name"></p>
            <p style="font-size: 12px;" id="visitor-phone"></p>
          </div>
          <div id="chat" style="height: 300px;" class="border mb-1">
          </div>
          <div id="input-wrapper" class="d-flex">
            <div class="flex-grow-1 mr-1">
              <c-input id="input" type="text" placeholder="Type your message here..."></c-input>
            </div>
            <div class="flex-shrink-0">
              <button id="send-button" class="btn btn-primary"><I class="fa fa-paper-plane" id="send-icon"></I>
                Kirim</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
    const gun = Gun("https://ddb.bimasoft.web.id/gun");
    const btn = document.getElementById("send-button");
    const btnBio = document.getElementById("save-biodata");

    const nama = localStorage.getItem("nama");
    const nowa = localStorage.getItem("nowa");

    if (nama && nowa) {
      document.getElementById("chat-wrapper").classList.remove("d-none");
      document.getElementById("biodata-wrapper").classList.add("d-none");
      initChat();
    }


    btn.onclick = () => {
      const username = localStorage.getItem("nowa");

      const msg = `Client : ${getVal("input")}`;
      gun.get("bimasoft").get("livechat").get(username).set(msg);
      setVal("input", "");
    };

    btnBio.onclick = () => {
      const nama = getVal("nama");
      const nowa = getVal("nowa");
      localStorage.setItem("nama", nama);
      localStorage.setItem("nowa", nowa);
      document.getElementById("chat-wrapper").classList.remove("d-none");
      document.getElementById("biodata-wrapper").classList.add("d-none");
      initChat();
    };

    function initChat() {
      const username = localStorage.getItem("nowa");
      const nama = localStorage.getItem("nama");

      document.getElementById("visitor-name").innerText = nama;
      document.getElementById("visitor-phone").innerText = username;

      gun.get("bimasoft").get("livechat").get(username).on(chats => {
        document.getElementById("chat").innerHTML = "";
        for (const key of Object.keys(chats)) {
          if (key === "_") continue;

          const msg = chats[key]
          const div = document.createElement("div");
          if (msg.includes("Client : ")) {
            div.className = "border ml-2 my-2 bg-secondary text-white py-1 px-3 rounded w-75";
          }
          if (msg.includes("Operator : ")) {
            div.className = "border my-2 ml-auto mr-2 bg-primary text-white py-1 px-3 rounded w-75";
          }
          div.innerText = msg.replace("Client : ","").replace("Operator : ","");
          document.getElementById("chat").appendChild(div);
        }
      })

    }

    </script>
  </body>
</html>
